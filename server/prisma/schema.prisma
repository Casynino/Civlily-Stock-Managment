generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StaffRole {
  ADMIN
  MANAGER
  CASHIER
  STOREKEEPER
}

enum SalePaymentMethod {
  CASH
  CARD
  MOBILE_MONEY
  BANK_TRANSFER
  OTHER
}

enum TransferStatus {
  PENDING
  APPROVED
  COMPLETED
}

model Staff {
  id           String    @id @default(cuid())
  staffId      String    @unique
  name         String
  email        String?   @unique
  passwordHash String
  role         StaffRole
  status       String    @default("Active")

  branchId String?
  branch   Branch?  @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales    Sale[]
  expenses Expense[]
}

model Branch {
  id        String   @id @default(cuid())
  name      String   @unique
  manager   String?
  status    String   @default("Active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff       Staff[]
  stock       BranchStock[]
  sales       Sale[]
  expenses    Expense[]
  transfersFrom Transfer[] @relation("TransferFrom")
  transfersTo   Transfer[] @relation("TransferTo")
}

model Product {
  id           String   @id @default(cuid())
  code         String?  @unique
  sku          String?  @unique
  name         String
  qr           String?  @unique
  sellingPrice Decimal  @default(0)
  costPrice    Decimal  @default(0)
  status       String   @default("Active")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stock     BranchStock[]
  saleItems SaleItem[]
  transfers Transfer[]
}

model BranchStock {
  branchId  String
  productId String
  quantity  Int      @default(0)
  updatedAt DateTime @updatedAt

  branch  Branch  @relation(fields: [branchId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@id([branchId, productId])
}

model Sale {
  id            String            @id @default(cuid())
  code          String            @unique
  date          String
  time          String
  total         Decimal           @default(0)
  paid          Decimal           @default(0)
  change        Decimal           @default(0)
  status        String            @default("Paid")
  paymentMethod SalePaymentMethod

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  staffId String
  staff   Staff @relation(fields: [staffId], references: [id])

  items     SaleItem[]
  createdAt DateTime @default(now())
}

model SaleItem {
  id        String  @id @default(cuid())
  saleId    String
  productId String
  qty       Int
  price     Decimal @default(0)
  total     Decimal @default(0)

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

model Expense {
  id        String   @id @default(cuid())
  date      String
  title     String
  amount    Decimal
  note      String?

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  staffId String
  staff   Staff @relation(fields: [staffId], references: [id])

  createdAt DateTime @default(now())
}

model Transfer {
  id        String         @id @default(cuid())
  date      String
  qty       Int
  status    TransferStatus @default(PENDING)

  fromBranchId String
  toBranchId   String
  productId    String

  fromBranch Branch  @relation("TransferFrom", fields: [fromBranchId], references: [id])
  toBranch   Branch  @relation("TransferTo", fields: [toBranchId], references: [id])
  product    Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  balance   Decimal  @default(0)
  status    String   @default("Active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([phone])
}
